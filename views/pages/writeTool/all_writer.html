<div class="uk-container uk-container-xlarge main_page">
    <div class="uk-flex uk-width-1 uk-flex-center uk-margin-medium-top uk-margin-small-bottom">

        <div class="uk-width-3-4 uk-flex-center main_pc_writer">

            <form class="uk-width-1" id="article_editor" method="POST" enctype="multipart/form-data">
                <div class="uk-flex uk-flex-left">
                    <img src="/static/picture_pool/1615876497412.png" style="width:35px;height:35px">
                    <h3 class="uk-margin-small-bottom" style="text-decoration: underline;">写作博客</h3>
                </div>
                <hr>
                <br>

                <div uk-grid class="uk-grid-small">
                    <div class="uk-width-5-6">
                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div class="uk-width-1-6" style="background-color: #f7f7f7;padding:11px" uk-height-match=".uk-width-1-3">
                                <label class="uk-form-label" for="form-stacked-select">文章类别</label><br>
                            </div>
                            <div class="uk-width-1-5">
                                <select class="uk-input" id="article_class1" name="article_class1" type="text" uk-border-pill style="background: #fff;color: #111;border: 2px solid #e6d4d4;">
                                    <option value="">请选择</option>
                                    <option value="Go">Go语言相关</option>
                                    <option value="Go">Python语言相关</option>
                                    <option value="Go">数据库</option>
                                    <option value="Go">云原生</option>
                                    <option value="Go">算法与数据结构</option>
                                    <option value="Go">漫画技术</option>
                                    <option value="Go">LeetCode漫画题解</option>
                                    <option value="Go">知识星球精华分享</option>
                                </select>
                            </div>
                        </div>
                        <br>
                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div class="uk-width-1-6" style="background-color: #f7f7f7;padding:11px" uk-height-match=".uk-width-1-3">
                                <label class="uk-form-label" for="form-stacked-select">文章标签(由用户创建)</label><br>
                            </div>
                            <div class="uk-width-1-5">
                                <select class="uk-input" id="article_class1" name="article_class1" type="text" uk-border-pill style="background: #fff;color: #111;border: 2px solid #e6d4d4;">
                                    <option value="">请选择</option>
                                    <option value="Go">Go</option>
                                    <option value="Go">新建</option>
                                </select>
                            </div>
                        </div>

                        <br>
                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div class="uk-width-1-6" style="background-color: #f7f7f7;padding:11px" uk-height-match=".uk-width-1-3">
                                <label class="uk-form-label" for="form-stacked-select">文章标题</label><br>
                            </div>
                            <div class="uk-width-3-4">
                                <input class="uk-input" type="text" id="article_title" name="title" placeholder="文章标题" style="background: #fff;color: #111;border: 2px solid #e6d4d4;">
                                <input class="uk-input" type="text" id="main_pic_path" name="main_pic_path" value={{.main_pic_path}} uk-border-pill  style="display:none">
                            </div>
                        </div>

                        <br>
                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div class="uk-width-1-6" style="background-color: #f7f7f7;padding:33px;margin-bottom: 26px;" uk-height-match=".uk-width-1-3">
                                <label class="uk-form-label" for="form-stacked-select">文章题图</label><br>
                            </div>
                            <div class="uk-width-1-2">
                                <div class="js-upload uk-placeholder uk-text-center">
                                    <span uk-icon="icon: cloud-upload"></span>
                                    <span class="uk-text-middle">将需要上传的图片拖到此处，或者</span>
                                    <div uk-form-custom>
                                        <input type="file" multiple>
                                        <span class="uk-link">直接选择</span>
                                    </div>
                                </div>
                                <progress id="js-progressbar" class="uk-progress" value="0" max="100" style="height: 3px;background-color: #9e9a9a;" show></progress>
                            </div>
                            
                            <div class="uk-width-1-5" style="margin-left: 50px;padding-left: 20px;">
                                <input class="upload-url" name="upload-url" style="display:none">
                                <img class="upload-img" data-src="" sizes="(min-width: 650px) 650px, 100vw" width="650" height="433" alt="" uk-img>
                            </div>
                        </div>

                        <br>

                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div class="uk-width-6-6">
                                <textarea class="uk-textarea summary" maxlength="120" name="summary" rows="5" placeholder="文章摘要(不超过120字)"></textarea>
                            <i class="uk-flex uk-flex-right "><span class="count-change">0</span>/120</i>
                            </div>
                        </div>
                        
                        <br>
                        <div class="uk-text-center uk-flex-middle uk-grid-collapse" uk-grid>
                            <div uk-switcher="animation: uk-animation-fade; toggle: > *">
                                <button class="uk-button uk-button-default" type="button">Markdown编辑器</button>
                                <button class="uk-button uk-button-default" type="button">富文本编辑器</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="leoaylog-editor" class="uk-margin-medium-top">
                </div>
            </form>

            <button class="uk-button uk-button-primary  uk-margin-medium-left" id="publish">发布文章</button>
            <button class="uk-button uk-button-primary uk-margin-small-left " id="savetemp">保存草稿</button>
            <button class="uk-button uk-button-danger uk-margin-small-left" type="button" id="genPic1" uk-toggle="target: #modal-close-default">生成分享图</button>
            <br>
            <br>

            <div id="modal-close-default" uk-modal>
                <div class="uk-modal-dialog uk-modal-body">
                    <button class="uk-modal-close-default" type="button" uk-close></button>
                    <div id="shareCard" style="padding:15px;background: #1b1c1f;color: #f4e1b9;border-radius: 0 30px 0 0;border: #fff 15px;border-style: solid;box-shadow: black;box-shadow: darkgrey 4px -3px 20px 3px;">
                        <br>
                        <h2 class="uk-modal-title" style="color: #f4e1b9;font-size: 2em;"></h2>
                        <hr>
                        <br>
                        <div class="cas_content"></div>
                        <br>
                        <br>
                        <div id="imgArea" style="display:none; "></div>
                        <br>
                        <div class="uk-panel uk-panel-box uk-text-truncate uk-flex uk-flex-center" style="color:#A4A4A4">【由leoay写作工具生成】</div>
                    </div>

                    <div class="uk-modal-footer uk-text-right">
                        <button class="uk-button uk-button-default uk-modal-close" type="button">取消</button>
                        <button class="uk-button uk-button-primary" id="saveGenCard" type="button">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图片上传组件 -->
<script>     
    var bar = document.getElementById('js-progressbar');
    UIkit.upload('.js-upload', {
        url: '/picpool/upload',
        name: 'editormd-image-file',
        multiple: true,
        beforeSend: function () {
            console.log('beforeSend', arguments);
        },
        beforeAll: function () {
            console.log('beforeAll', arguments);
        },
        load: function () {
            console.log('load', arguments);
        },
        error: function () {
            console.log('error', arguments);
        },
        complete: function () {
            console.log('complete', arguments);
        },

        loadStart: function (e) {
            console.log('loadStart', arguments);
            bar.removeAttribute('hidden');
            bar.max = e.total;
            bar.value = e.loaded;
        },

        progress: function (e) {
            console.log('progress', arguments);

            bar.max = e.total;
            bar.value = e.loaded;
        },

        loadEnd: function (e) {
            console.log('loadEnd', arguments);

            bar.max = e.total;
            bar.value = e.loaded;
        },

        completeAll: function (result) {
            console.log('completeAll', arguments);

            setTimeout(function () {
                bar.setAttribute('hidden', 'hidden');
            }, 1000);

            var url = JSON.parse(result.response).url;
            $(".upload-img").attr("data-src", url);
            $(".upload-url").val(url);
        }
    });
</script>

<!-- 写作工具组件 -->
<script type="text/javascript">
    $(function() {
        var editor = editormd("leoaylog-editor", {
            width: "100%",
            height: 600,
            path: "/static/editormd/lib/",
            saveHTMLToTextarea: true,
            watch: true,
            showTrailingSpace: false,
            preview: true,
            emoji: true,
            placeholder: "写一篇",
            markdown: {{.markdown}},
            autoHeight: false,
            styleActiveLine: false,
            lineWrapping: false,
            imageUpload: true,
            lineNumbers: false,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp", "svg"],
            imageUploadURL: "/picpool/upload",
            toolbarIcons: function() {
                return ["h2", "h3", "h6", "|", "bold", "code", "code-block", "link", "reference-link", "|", "image", "watch", "fullscreen"]
            },
        });
    });

</script>
</script>

  <script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
<script>
     $.get("http://leoay.xyz:8085/picpool/queryimages?pageIndex=1", function(result){
        console.log(result);
         var obj = JSON.parse(result);
         img_obj = obj.image_list;
        
            var content = "";
            for(i<0;i<8;++i) {
                content = content +  "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>";
            }
        //  var content = 
        //   "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
        //     "<li class=\"pic_select_item\" style=\"padding: 20px\"><img data-src=\"http://v3.getuikit.work/skin/ukv3/images/light.jpg\" alt=\"\" uk-img></li>"
           
            var headContent = "<ul class=\"\" style=\"display: -webkit-box;-webkit-flex-wrap: wrap;margin-top:0\">";
            var tailContent =  "</ul>" + "</div>" + "</div>" ;

        $(".pic_list").append(headContent + content + tailContent);
     });

    //加载分页组件
    $(".page_sep").append(
      " <ul class=\"uk-pagination uk-flex-center\" uk-margin> "             +  
      "     <li><a href=\"#\"><span uk-pagination-previous></span></a></li> "   +    
      "     <li><a href=\"#\">1</a></li> "                                      +    
      "     <li class=\"uk-disabled\"><span>...</span></li> "                   +    
      "     <li><a href=\"#\">5</a></li> "                                       + 
      "     <li><a href=\"#\">6</a></li>"                                       +       
      "     <li class=\"uk-active\"><span>7</span></li> "                       +          
      "     <li><a href=\"#\">8</a></li> "                                      +
      "     <li><a href=\"#\"><span uk-pagination-next></span></a></li> "       +     
      "</ul> "                                                           
   );
</script>

<script>
    //界面初始化
    if(({{.articleid}} != null) && (!{{.istemp}})) {
        $("#savetemp").hide();
    }

    var url = document.location.toString();
    var isCreate = (url.search("edit_article")== -1);
        //alert(isCreate);
        if(isCreate) {
            $("#main_pic").attr('data-src', 'http://leoay.xyz:8085/static/picture_pool/1615885749016.png');
            $("#main_pic").attr('src', 'http://leoay.xyz:8085/static/picture_pool/1615885749016.png');
            $("#main_pic").attr('width', 100);
            $("#main_pic").attr('href', "#modal-pic-select");
        }else {
        
    }
</script>

<script>
    $(".editormd-markdown-textarea").bind('input propertychange', function() {
        alert($(".editormd-html-textarea").val())
    });

    $("#genPic1").click(function() {
        $(".uk-modal-title").text($("#article_title").val());
        $(".cas_content").html($(".editormd-html-textarea").val());
    });
</script>
<script src="/static/js/html2canvas.js"></script>

<script>
    function downloadFile(content, fileName) { //下载base64图片
        var base64ToBlob = function(code) {
            let parts = code.split(';base64,');
            let contentType = parts[0].split(':')[1];
            let raw = window.atob(parts[1]);
            let rawLength = raw.length;
            let uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            return new Blob([uInt8Array], {
                type: contentType
            });
        };
        let aLink = document.createElement('a');
        let blob = base64ToBlob(content); //new Blob([content]);
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("click", true, true); //initEvent 不加后两个参数在FF下会报错  事件类型，是否冒泡，是否阻止浏览器的默认行为
        aLink.download = fileName;
        aLink.href = URL.createObjectURL(blob);
        aLink.click();
    };

    //
    $("#saveGenCard").click(function() {
        html2canvas(document.querySelector("#shareCard"), {
            allowTaint: true,
            useCORS: true,
            taintTest: false,
            scale: 3.5,
            y: document.querySelector("#shareCard").getBoundingClientRect().top + window.scrollY,
            async: false, // 是否异步解析和呈现元素
            // 以下字段必填
        }).then(canvas => {
            let oImg = new Image();
            oImg.src = canvas.toDataURL(); // 导出图片
            $("#imgArea").append(oImg);
        });

        var base64ToBlob = function(code) {
            let parts = code.split(';base64,');
            let contentType = parts[0].split(':')[1];
            let raw = window.atob(parts[1]);
            let rawLength = raw.length;
            let uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            return new Blob([uInt8Array], {
                type: contentType
            });
        };
        let aLink = document.createElement('a');
        let blob = base64ToBlob(imgData); //new Blob([content]);
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("click", true, true); //initEvent 不加后两个参数在FF下会报错  事件类型，是否冒泡，是否阻止浏览器的默认行为
        aLink.download = "下载.png";
        aLink.href = URL.createObjectURL(blob);
        aLink.click();

    })
</script>

<script>
    //监测从后台获取的可编辑文字、键盘输入的文字字数的变化，并赋值给span
    $(function() {
        var text = $('.summary').val();
        var len = text.length;
        $('.summary').next().find('span').html(len);
        $('.summary').keyup(function() {
            var text = $(this).val();
            len = text.length;
            if (len > 120) {
                return false;
            }
            $(this).next().find('span').html(len);
        })
    });
</script>

<script>
    document.addEventListener("keydown", function(e) {
        //可以判断是不是mac，如果是mac,ctrl变为花键
        //event.preventDefault() 方法阻止元素发生默认的行为。
        if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
            e.preventDefault();
            // Process event...
            UIkit.notification({
                message: "保存成功"
            })
        }
    }, false);
</script>

<script>
    //点击按钮，发布文章
    $("#publish").click(function() {
        //alert("sdsdsd")
        //ToDo: 使用ajax 发送post请求
        $("#article_editor").attr('action', '/writeTool/publish?newarticle={{.newarticle}}&articleid={{.articleid}}');
        $("#article_editor").submit();
    });

    //点击按钮，暂存文章
    $("#savetemp").click(function() {
        //alert("sdsdsd")
        //ToDo: 使用ajax 发送post请求
        //获取当前url是否是新建的文章
        var url = document.location.toString();
        var isCreate = (url.search("edit_article")== -1);
        //alert(isCreate);
        if(isCreate) {
            //创建新文章
            $("#article_editor").attr('action', '/writeTool/save_temp');
            $("#article_editor").submit();
        }else {
            //编辑原来的文章
            alert({{.articleid}});
            $("#article_editor").attr('action', '/writeTool/save_temp?newarticle={{.newarticle}}&articleid={{.articleid}}');
            $("#article_editor").submit();
        }

        // $("#article_editor").attr('action', '/writeTool/save_temp');
        // $("#article_editor").submit();
    });
</script>


<script>
    //初始化标题
    $("#article_title").val({{.artTitle}});
    //一级类目
    $("#article_class1").val({{.firstClass}});

    //二级类目
    $("#article_class2").val({{.secondClass}});

    //文章摘要
    $(".summary").val({{.summary}});

    //文章主图连接
    $("#article_main_pic").val({{.main_pic_path}});
</script>

<script>
    //异步请求加载图片json数据
    $("#selectInnerPicPool").click(function() {
        $.ajax({
            url: "/picpool/queryimages",
            async: true,
            success: function(result) {
                var obj = jQuery.parseJSON(result)
                console.log(obj.image_row)
                var imgrowind
                $.each(obj.image_row, function(index, obji) {
                    //console.log("++++++++++++++++++111" + index)
                    $(".picpool_model").append("<div class=\"uk-grid-small uk-child-width-expand@s uk-text-center uk-margin-large-top picpool_model_image_row" + imgrowind + "\" uk-grid>");
                    s
                    $.each(obji, function(index2, obj1) {
                        $.each(obj1, function(index, obj2) {
                            $("picpool_model_image_row" + imgrowind).append("<div><div class=\"uk-background-muted uk-padding\">Item</div></div>");
                        });
                        $(".picpool_model").append("</div>");
                    });
                    //$("/picpool_model").append("<div class=\"uk-grid-small uk-child-width-expand@s uk-text-center uk-margin-large-top\" uk-grid>");
                    //$.each(obji)
                });
            }
        });
    });
</script>

<script>
       $("#uk-card-body").click(function(e){
        console.log("sdsdd")
    });
</script>